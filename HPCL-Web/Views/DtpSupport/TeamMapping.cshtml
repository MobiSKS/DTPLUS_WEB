@model HPCL.Common.Models.ViewModel.DtpSupport.TeamMappingViewModel
@using Microsoft.AspNetCore.Http;

<div class="col-lg-12">
    <div class="bg-white p-2 p-md-4">
        <ul class="breadcrumb bread_custom bg-transparent m-0 pb-1 py-0 px-0">
            <li class="breadcrumb-item"><a href="@Url.Action("Index","DtpSupport")" class="text_primary">DTP Support</a> </li>
            <li class="breadcrumb-item font-weight-light">Team Mapping</li>
        </ul>
        @if (ViewBag.SuccessMessage != "" && ViewBag.SuccessMessage!=null)
        {
            <div id="reason" class="mb-3 text-center alert alert-success">@ViewBag.SuccessMessage</div>
        }
        @if (ViewBag.ErrorMessage != "" && ViewBag.ErrorMessage!=null)
        {
            <div id="reason" class="mb-3 text-center alert alert-danger">@ViewBag.ErrorMessage</div>
        }
        <form id="formValid" class="toBeHiddenOnSuccess">
            <div class="w-100">
                <div class="col-lg-12 col-md-12 col-12 pl-0 pr-0">
                    <div class="border-1 rounded border-grey pb-3">
                        <p class="text_primary px-3 py-3 bg-grey m-0 font-weight-bold">Team Mapping</p>
                        <button class="btn btn_primary add_update_btn" type="button" id="AddRecord">ADD NEW RECORD</button>
                        <div class="col-lg-12 col-md-12 col-12 py-3">
                            <div class="d-flex align-items-center flex-wrap">
                                <div class="col-lg-6 col-12">
                                    <div class="d-flex align-items-center flex-wrap mb-3">
                                        <label id="lblCustomerId" class="font-weight-normal col-md-3 col-12 teamAdd">ZBM ID</label>
                                        <div class="col-md-7 col-12">
                                            <div class="custom_select">
                                                @Html.TextBoxFor(m => m.ZBMID, new { @class = "form-control",maxlength="30" })
                                                <span style="display:none" class="error" id="ZBMId_error"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-12">
                                    <div class="d-flex align-items-center flex-wrap mb-3">
                                        <label id="lblCustomerId" class="font-weight-normal col-md-3 col-12 teamAdd">ZBM Name</label>
                                        <div class="col-md-7 col-12">
                                            <div class="custom_select">
                                                @Html.TextBoxFor(m => m.ZBMName, new { @class = "form-control",maxlength="30" })
                                                <span style="display:none" class="error" id="ZBMName_error"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-12">
                                    <div class="d-flex align-items-center flex-wrap mb-3">
                                        <label id="lblCustomerId" class="font-weight-normal col-md-3 col-12 teamAdd">RSM ID</label>
                                        <div class="col-md-7 col-12">
                                            <div class="custom_select">
                                                @Html.TextBoxFor(m => m.RSMID, new { @class = "form-control" ,maxlength="30"})
                                                <span style="display:none" class="error" id="RSMId_error"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-12">
                                    <div class="d-flex align-items-center flex-wrap mb-3">
                                        <label id="lblCustomerId" class="font-weight-normal col-md-3 col-12 teamAdd">RSM Name</label>
                                        <div class="col-md-7 col-12">
                                            <div class="custom_select">
                                                @Html.TextBoxFor(m => m.RSMName , new { @class = "form-control" ,maxlength="30"})
                                                <span style="display:none" class="error" id="RSMName_error"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-12">
                                    <div class="d-flex align-items-center flex-wrap mb-3">
                                        <label id="lblCustomerId" class="font-weight-normal col-md-3 col-12 teamAdd">RBE ID</label>
                                        <div class="col-md-7 col-12">
                                            <div class="custom_select">
                                                @Html.TextBoxFor(m => m.RBEID, new { @class = "form-control" ,maxlength="30"})
                                                <span style="display:none" class="error" id="RBEId_error"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-12">
                                    <div class="d-flex align-items-center flex-wrap mb-3">
                                        <label id="lblCustomerId" class="font-weight-normal col-md-3 col-12 teamAdd">RBE Name</label>
                                        <div class="col-md-7 col-12">
                                            <div class="custom_select">
                                                @Html.TextBoxFor(m => m.RBEName, new { @class = "form-control" ,maxlength="30"})
                                                <span style="display:none" class="error" id="RBEName_error"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-12">
                                    <div class="d-flex align-items-center flex-wrap mb-3">
                                        <label id="lblCustomerId" class="font-weight-normal col-md-3 col-12 teamAdd">Location</label>
                                        <div class="col-md-7 col-12">
                                            <div class="custom_select">
                                                @Html.TextBoxFor(m => m.Location, new { @class = "form-control" ,maxlength="30" })
                                                <span style="display:none" class="error" id="Location_error"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="clearfix"></div>
                            <div class="d-flex align-items-center justify-content-center mt-0">
                                <div class="px-2 teamAdd" style="display:none;">
                                    <button class="btn btn_primary" type="button" id="btnAdd">ADD</button>
                                </div>
                                <div class="px-2">
                                    <button class="btn btn_primary teamSearch" type="submit" id="btnSearch">SEARCH</button>
                                </div>
                                <div class="px-2">
                                    <button class="btn btn_primary" type="button" id="btnReset" onclick="location.href='@Url.Action("TeamMapping", "DtpSupport", new { reset="Y" })'">RESET</button>
                                </div>
                                  <div class="px-2 teamAdd" style="display:none;">
                                    <button class="btn btn_primary" type="button" onclick="location.href='@Url.Action("TeamMapping", "DtpSupport")'",id="btnSearch">SEARCH</button>
                                </div>
                            </div>

                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </div>
        </form>
        <div class="clearfix"></div>

        <div class="clearfix"></div>
        @if (ViewBag.Reset != "Y")
        {
            <div id="show_Table" class="col-lg-12 col-md-12 col-12 pl-0 pr-0 mt-3">
                @if (Model.Data.Count() > 0)
                {

                    <table class="datatable table table-striped table-bordered table-responsive d-md-table" style="width:100%;" id="TeamMapSearch">
                        <thead style="background-color:lightgray;">
                            <tr>
                                
                                <th style="display:none">Sl No.</th>
                                <th>ZBM ID</th>
                                <th>ZBM Name</th>
                                <th>RSM ID</th>
                                <th>RSM Name</th>
                                <th>RBE ID</th>
                                <th>RBE Name</th>
                                <th>Location</th>
                                <th>Action</th>
                                <th style="display:none">ID</th>

                            </tr>
                        </thead>
                        <tbody id="searchTableBody">
                            @{
                                int i = 0;
                            }
                            @foreach (var item in Model.Data)
                            {
                                i = i + 1;

                                <tr >
                                    <td  style="display:none" >@i</td>
                                    <td class="editCell" id="tdZBMId" >@item.ZBMId</td>
                                    <td class="editCell" id="tdZBMName"  >@item.ZBMName</td>
                                    <td class="editCell" id="tdRSMId">@item.RSMId</td>
                                    <td class="editCell" id="tdRSMName">@item.RSMName</td>
                                    <td class="editCell" id="tdRBEId">@item.RBEId</td>
                                    <td class="editCell" id="tdRBEName">@item.RBEName</td>
                                    <td class="editCell" id="tdLocation" >@item.Location</td>


                                    <td  style="width:8px" >
                                        <div class="d-flex align-items-center justify-content-start">
                                            <a class="d-block edit" data-toggle="tooltip" title="" tooltip="Edit"><i class="fa fa-pencil-square-o edit" aria-hidden="true"></i></a>
                                            <a class="d-block save" data-toggle="tooltip" title="" tooltip="Update"><i class="fa fa-floppy-o save" aria-hidden="true" style="display:none"></i></a>
                                            <a class="d-block cancel" data-toggle="tooltip" title="" tooltip="Cancel"><i class="fa fa-remove cancel" aria-hidden="true" style="display:none"></i></a>
                                            <a asp-action="DeleteTeamMapping" class="d-block" asp-route-TeamMappingId="@item.TeamMappingId" onclick="return confirm('Do you want to delete this record ?');" data-toggle="tooltip" title="" tooltip="Delete"><i class="fa fa-trash-o" aria-hidden="true"></i></a>
                                        </div>
                                    </td>
                                    <td style="display:none">@item.TeamMappingId</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <div class="clearfix"></div>
                }
                else
                {
                    <div class="mb-3 text-center alert alert-danger">
                        @Model.Message
                    </div>
                }
            </div>
        }
        <div class="clearfix"></div>
        <input type="hidden" id="Status">
    </div>
</div>

<script type="text/javascript">
    var pageStatus="@ViewBag.Reset";//ViewBag.Reset has value "Y" for reset click, "A" for Add button click 
    var activeRow="";
     var pZBMId = "", pZBMName = "", pRSMId = "",pRSMName = "", pRBEId = "", pRBEName = "",plocation ="";
    $(document).ready(function () {
        

        if(pageStatus=="A"){
           if(!$("label.teamAdd").hasClass("Required")){
                $("label.teamAdd").addClass("Required");
                $("label.teamAdd").append('<sup class="text-danger">*</sup>');
           }
           $("#Status").val("ADD");
           $(".teamAdd").attr("style","display:block");
           $(".teamSearch").attr("style","display:none");
        }
        else{
             $("#Status").val("");
            $("label.teamAdd").removeClass("Required");
        }
    });

     $("#AddRecord").click(function(){
         if(!$("label.teamAdd").hasClass("Required")){
            $("label.teamAdd").addClass("Required");
            $("label.teamAdd").append('<sup class="text-danger">*</sup>');
         }

        $(".teamAdd").attr("style","display:block");
        $(".teamSearch").attr("style","display:none");
        
        $("#Status").val("ADD");
    });
    $("#btnAdd").click(function(){
        var flag = "Y";
        //debugger;
        if($("#ZBMID").val().trim()==""){
            $("#ZBMId_error").html("ZBM ID is required");
            $("#ZBMId_error").attr("style","display:block");
            flag="N";
        }
        if($("#ZBMName").val().trim()==""){
            $("#ZBMName_error").html("ZBM Name is required");
             $("#ZBMName_error").attr("style","display:block");
            flag="N";
        }
        if($("#RSMID").val().trim()==""){
            $("#RSMId_error").html("RSM ID is required");
             $("#RSMId_error").attr("style","display:block");
            flag="N";
        }
        if($("#RSMName").val().trim()==""){
            $("#RSMName_error").html("RSM Name is required");
             $("#RSMName_error").attr("style","display:block");
            flag="N";
        }
        if($("#RBEID").val().trim()==""){
            $("#RBEId_error").html("RBE ID is required");
             $("#RBEId_error").attr("style","display:block");
            flag="N";
        }
        if($("#RBEName").val().trim()==""){
            $("#RBEName_error").html("RBE Name is required");
             $("#RBEName_error").attr("style","display:block");
            flag="N";
        }
        if($("#Location").val().trim()==""){
            $("#Location_error").html("Location is required");
             $("#Location_error").attr("style","display:block");
            flag="N";
        }

        if (flag == "Y") {
            var reqData=$('#formValid').serialize();
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("AddTeamMapping", "DtpSupport")',
                    data:reqData,
                    dataType: 'json',
                    success: function (data) {
                        var successMsg="",errorMsg="";
                        if(data[0].status==1)
                            successMsg=data[0].reason;
                        else if(data[0].status==0)
                            errorMsg=data[0].reason;
                        var url = '@Html.Raw(@Url.Action("TeamMapping", "DtpSupport",new { reset = "A", success = "mm", error = "ee" }))';
                        url = url.replace("mm", encodeURIComponent(successMsg)).replace("ee", encodeURIComponent(errorMsg));
                       window.location.href=url;
                    },
                    error: function (ex) {
                        alert('Error.' + ex);
                    }
                });

        }
    });
    $("#ZBMID").on("blur", function () {
         var zbmId = $("#ZBMID").val();
         if (zbmId.trim() == "") {
             if( $("#Status").val()=="ADD"){
                $("#ZBMId_error").html("ZBM ID is required");
                $("#ZBMId_error").attr("style","display:block");
             }
             else{
                 $("#ZBMId_error").attr("style", "display:none");
                 $("#ZBMId_error").html("");
             }
         }
         else{
             $("#ZBMId_error").attr("style", "display:none");
             $("#ZBMId_error").html("");
         }
     });
        $("#ZBMName").on("blur", function () {
         var zbmName = $("#ZBMName").val();
         if (zbmName.trim() == "") {
             if( $("#Status").val()=="ADD"){
                $("#ZBMName_error").html("ZBM Name is required");
                $("#ZBMName_error").attr("style","display:block");
             }
             else{
                 $("#ZBMName_error").attr("style", "display:none");
                 $("#ZBMName_error").html("");
             }
         }
         else{
             $("#ZBMName_error").attr("style", "display:none");
             $("#ZBMName_error").html("");
         }
     });
      $("#RSMID").on("blur", function () {
         var rsmId = $("#RSMID").val();
         if (rsmId.trim() == "") {
             if( $("#Status").val()=="ADD"){
                $("#RSMId_error").html("RSM ID is required");
                $("#RSMId_error").attr("style","display:block");
             }
             else{
                 $("#RSMId_error").attr("style", "display:none");
                 $("#RSMId_error").html("");
             }
         }
         else{
             $("#RSMId_error").attr("style", "display:none");
             $("#RSMId_error").html("");
         }
     });

      $("#RSMName").on("blur", function () {
         var rsmName = $("#RSMName").val();
         if (rsmName.trim() == "") {
             if( $("#Status").val()=="ADD"){
                $("#RSMName_error").html("RSM Name is required");
                $("#RSMName_error").attr("style","display:block");
             }
             else{
                 $("#RSMName_error").attr("style", "display:none");
                 $("#RSMName_error").html("");
             }
         }
         else{
             $("#RSMName_error").attr("style", "display:none");
             $("#RSMName_error").html("");
         }
     });
      $("#RBEID").on("blur", function () {
         var rbeId = $("#RBEID").val();
         if (rbeId.trim() == "") {
             if( $("#Status").val()=="ADD"){
                $("#RBEId_error").html("RBE ID is required");
                $("#RBEId_error").attr("style","display:block");
             }
             else{
                 $("#RBEId_error").attr("style", "display:none");
                 $("#RBEId_error").html("");
             }
         }
         else{
             $("#RBEId_error").attr("style", "display:none");
             $("#RBEId_error").html("");
         }
     });
      $("#RBEName").on("blur", function () {
         var rbeName = $("#RBEName").val();
         if (rbeName.trim() == "") {
             if( $("#Status").val()=="ADD"){
                $("#RBEName_error").html("RBE Name is required");
                $("#RBEName_error").attr("style","display:block");
             }
             else{
                 $("#RBEName_error").attr("style", "display:none");
                 $("#RBEName_error").html("");
             }
         }
         else{
             $("#RBEName_error").attr("style", "display:none");
             $("#RBEName_error").html("");
         }
     });
      $("#Location").on("blur", function () {
         var location = $("#Location").val();
         if (location.trim() == "") {
             if( $("#Status").val()=="ADD"){
               $("#Location_error").html("Location is required");
                $("#Location_error").attr("style","display:block");
             }
             else{
                 $("#Location_error").attr("style", "display:none");
                 $("#Location_error").html("");
             }
         }
         else{
             $("#Location_error").attr("style", "display:none");
             $("#Location_error").html("");
         }
     });

     $("#TeamMapSearch").on('click', '.edit', function () {
        if(activeRow==""){
            currentRow = $(this).closest("tr");
            activeRow=currentRow;
            var i = currentRow[0].cells[0].textContent;
            pZBMId = currentRow[0].cells[1].textContent;
           pZBMName = currentRow[0].cells[2].textContent;
           pRSMId = currentRow[0].cells[3].textContent;
           pRSMName = currentRow[0].cells[4].textContent;
           pRBEId = currentRow[0].cells[5].textContent;
           pRBEName = currentRow[0].cells[6].textContent;
           plocation = currentRow[0].cells[7].textContent;
            currentRow.find('td.editCell').each(function(){
                          
                          $(this)[0].innerHTML=('<input type="text" onblur="validateText(this);" maxlength="30" class="form-control" value="'+ $(this)[0].textContent + '" id="'+$(this)[0].id+'_'+i+'"><span class="field-validation-error text-danger" id="'+$(this)[0].id+'_error'+i+'"></span>');
                      });
           $('#tdZBMId_'+i).focus();
           

           currentRow.find('.edit').attr("style","display:none");
           currentRow.find('.save').attr("style","display:block");
           currentRow.find('.cancel').attr("style","display:block");
       }
    });
     $("#TeamMapSearch").on('click', '.cancel', function () {
          currentRow = $(this).closest("tr");
          //currentRow.find('td.editCell').each(function(){
          //             $(this).removeClass('edit-feild');
          //        });
          currentRow[0].cells[1].textContent=pZBMId;
          currentRow[0].cells[2].textContent=pZBMName;
          currentRow[0].cells[3].textContent=pRSMId;
          currentRow[0].cells[4].textContent=pRSMName;
          currentRow[0].cells[5].textContent=pRBEId;
          currentRow[0].cells[6].textContent=pRBEName;
          currentRow[0].cells[7].textContent=plocation;
         
       currentRow.find('.edit').attr("style","display:block");
       currentRow.find('.save').attr("style","display:none");
       currentRow.find('.cancel').attr("style","display:none");
       activeRow="";
     });
     $("#TeamMapSearch").on('click', '.save', function () {
         var flag="Y";
          row = $(this).closest("tr");
          var i = row[0].cells[0].textContent;
          var zbmId = $('#tdZBMId_'+i).val();
          var zbmName= $('#tdZBMName_'+i).val();
          var RSMId =  $('#tdRSMId_'+i).val();
          var RSMName = $('#tdRSMName_'+i).val();
          var RBEId = $('#tdRBEId_'+i).val();
          var RBEName = $('#tdRBEName_'+i).val();
          var location = $('#tdLocation_'+i).val();
          var teamMappingID = row[0].cells[9].textContent;
          if(zbmId.trim()==""){
              $('#tdZBMId_error'+i).html("ZBM ID is required");
              flag="N";
          }
          if(zbmName.trim()==""){
              $('#tdZBMName_error'+i).html("ZBM Name is required");
              flag="N";
          }
          if(RSMId.trim()==""){
              $('#tdRSMId_error'+i).html("RSM ID is required");
              flag="N";
          }
          if(RSMName.trim()==""){
              $('#tdRSMName_error'+i).html("RSM Name is required");
              flag="N";
          }
          if(RBEId.trim()==""){
              $('#tdRBEId_error'+i).html("RBE ID is required");
              flag="N";
          }
          if(RBEName.trim()==""){
              $('#tdRBEName_error'+i).html("RBE Name is required");
              flag="N";
          }
          if(location.trim()==""){
              $('#tdLocation_error'+i).html("Location is required");
              flag="N";
          }
          if(flag=="Y"){
             var reqmodel={ ZBMID: zbmId, ZBMName: zbmName, RSMID: RSMId,RSMName:RSMName,RBEId:RBEId,RBEName:RBEName,Location:location,TeamMappingID:teamMappingID};
             $.ajax({
                    type: 'POST',
                    url: '@Url.Action("UpdateTeamMapping", "DtpSupport")',
                    contentType: "application/json; charset=utf-8",
                    data:JSON.stringify(reqmodel),
                    dataType: 'json',
                    success: function (data) {
                        var successMsg="",errorMsg="";
                        if(data[0].status==1)
                            successMsg=data[0].reason;
                        else if(data[0].status==0)
                            errorMsg=data[0].reason;
                        var url = '@Html.Raw(@Url.Action("TeamMapping", "DtpSupport",new {  success = "mm", error = "ee" }))';
                        url = url.replace("mm", encodeURIComponent(successMsg)).replace("ee", encodeURIComponent(errorMsg));
                        window.location.href=url;
                    },
                    error: function (ex) {
                        alert('Error.' + ex);
                    }
             });
           }
     });
     function validateText(e){
         if(activeRow!=""){
             var text=e.value;
             var id=e.id;
             var i = activeRow[0].cells[0].textContent;
             if(id=="tdZBMId_"+i){
                 if(text.trim()==""){
                      $('#tdZBMId_error'+i).html("ZBM ID is required");
                  }
                  else
                   $('#tdZBMId_error'+i).html("");
              }
              if(id=="tdZBMName_"+i){
                 if(text.trim()==""){
                      $('#tdZBMName_error'+i).html("ZBM Name is required");
                  }
                  else
                      $('#tdZBMName_error'+i).html("");
              }
              if(id=="tdRSMId_"+i){
                 if(text.trim()==""){
                      $('#tdRSMId_error'+i).html("RSM ID is required");
                  }
                  else
                      $('#tdRSMId_error'+i).html("");
              }
              if(id=="tdRSMName_"+i){
                 if(text.trim()==""){
                      $('#tdRSMName_error'+i).html("RSM Name is required");
                  }
                  else
                      $('#tdRSMName_error'+i).html("");
              }
             if(id=="tdRBEId_"+i){
                 if(text.trim()==""){
                      $('#tdRBEId_error'+i).html("RBE ID is required");
                  }
                  else
                      $('#tdRBEId_error'+i).html("");
              }
             if(id=="tdRBEName_"+i){
                 if(text.trim()==""){
                      $('#tdRBEName_error'+i).html("RBE Name is required");
                  }
                  else
                      $('#tdRBEName_error'+i).html("");
              }
              if(id=="tdLocation_"+i){
                 if(text.trim()==""){
                      $('#tdLocation_error'+i).html("Location is required");
                  }
                  else
                      $('#tdLocation_error'+i).html("");
              }
          }
     }
</script>