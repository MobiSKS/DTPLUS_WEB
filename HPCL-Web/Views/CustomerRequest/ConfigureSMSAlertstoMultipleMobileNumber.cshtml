@model HPCL.Common.Models.ViewModel.CustomerRequest.GetSmsAlertForMultipleMobileDetailReq

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ajax-unobtrusive/3.2.6/jquery.unobtrusive-ajax.js"></script>

<div class="col-lg-12">
    <div class="bg-white p-2 p-md-4">
        <ul class="breadcrumb bread_custom bg-transparent m-0 pb-1 py-0 px-0">
            <li class="breadcrumb-item"><a href="@Url.Action("Index")" class="text_primary">Requests</a> </li>
            <li class="breadcrumb-item font-weight-light">Configure SMS Alerts to Multiple Mobile Number(s)</li>
        </ul>
        <form id="formVal" method="post" data-ajax="true" data-ajax-controller="CustomerRequest" data-ajax-action="ConfigureSMSAlertstoMultipleMobileNumber" data-ajax-method="POST" data-ajax-success="OnSuccess" data-ajax-failure="OnFailure">
            <div class="w-100">
                <div class="col-lg-12 col-md-12 col-12 pl-0 pr-0">
                    <div class="border-1 rounded border-grey pb-3">
                        <p class="text_primary px-3 py-2 bg-grey m-0 font-weight-bold">Configure SMS Alerts to Multiple Mobile Number(s)</p>

                        <div id="successUpdate" class="mb-3 text-center alert alert-success" style="display:none;margin-top:2%;"></div>
                        
                        <div id="successDelete" class="mb-3 text-center alert alert-success" style="display:none;"></div>

                        <div class="col-lg-12 col-md-12 col-12 pt-3">

                            <fieldset class="border-1 rounded border-grey pb-3" style="margin-bottom:1%;">
                                <legend class="font-12 font-weight-bold d-inline-block w-auto ml-3 mb-0 px-2">Search</legend>
                                <div class="d-flex align-items-center flex-wrap">
                                    <div class="col-lg-12 col-12">
                                        <div class="d-flex align-items-center flex-wrap mb-0">
                                            <label class="font-weight-normal col-md-2 col-12">Customer ID <sup class="text-danger">*</sup></label>
                                            <div class="col-sm-3 col-md-3 col-12">
                                                <div class="custom_select">
                                                    @Html.TextBoxFor(m => m.CustomerID, new { @id = "CustomerDefaultVal", @class = "form-control", onkeypress = "return isNumberKey(event)" })
                                                    @Html.ValidationMessageFor(m => m.CustomerID, "", new { @class = "text-danger" })
                                                </div>
                                            </div>

                                            <div class="d-flex align-items-center justify-content-center flex-wrap mt-3 px-4">
                                                <div class="px-2 mb-3 col-sm-auto col-12 mb-sm-0 mb-2">
                                                    <button class="btn btn_primary regrate_btn" type="submit">Search</button>
                                                </div>
                                                <div class="px-2 mb-3 col-sm-auto col-12 mb-sm-0 mb-2">
                                                    <button class="btn btn_primary regrate_btn" type="button" onclick="resetClick()">Reset</button>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </fieldset>

                            <div class="clearfix"></div>

                            <div id="noRecord" class="mb-3 text-center alert alert-danger" style="display:none;margin-top:2%;"></div>

                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div>

                <div id="updateSection" style="display:none;">
                    <div class="col-lg-12 col-md-12 col-12 pl-0 pr-0 mt-3">
                        <div class="border-1 rounded border-grey pb-0">
                            <p class="text_primary px-3 py-2 bg-grey m-0 font-weight-bold">Customer Information</p>
                            <div class="col-lg-12 col-md-12 col-12 pt-3">
                                <div class="d-flex align-items-center flex-wrap">
                                    <div class="col-lg-6 col-12">
                                        <div class="d-flex align-items-center flex-wrap mb-3">
                                            <label class="font-weight-normal col-md-4 col-12">Customer Name</label>
                                            <div class="col-md-7 col-12">
                                                <div class="custom_select">
                                                    <input class="form-control" id="customerName" type="text" disabled>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 col-12">
                                        <div class="d-flex align-items-center flex-wrap mb-3">
                                            <label class="font-weight-normal offset-md-1 col-md-4 col-12">Name On Card</label>
                                            <div class="col-md-7 col-12">
                                                <div class="custom_select">
                                                    <input class="form-control" id="NameOnCard" type="text" disabled>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center flex-wrap">
                                    <div class="col-lg-6 col-12">
                                        <div class="d-flex align-items-center flex-wrap mb-3">
                                            <label class="font-weight-normal col-md-4 col-12">Registered Mobile</label>
                                            <div class="col-md-7 col-12">
                                                <div class="custom_select">
                                                    <input class="form-control" id="RegisteredMobile" type="text" disabled>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                        </div>
                    </div>

                    <div class="col-lg-12 col-md-12 col-12 pl-0 pr-0 mt-3">
                        <div class="border-1 rounded border-grey pb-0">
                            <p class="text_primary px-3 py-2 bg-grey m-0 font-weight-bold">Alternate Mobile Number(s)</p>

                            <table width="100%" border="0" id="alternameMobSection" class="table table-bordered">
                            </table>

                            <div class="clearfix"></div>

                            <div id="submitSection">
                                <div class="col-md-12 col-12">
                                    <div class="d-flex align-items-center justify-content-center flex-wrap mb-3">
                                        <div class="px-0">
                                            <button class="btn btn_primary regrate_btn" type="button" onclick="updateAlertnateMob()">Submit</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="clearfix"></div>
                        </div>
                    </div>
                </div>

                <div class="clearfix"></div>

            </div>
        </form>
        <div class="clearfix"></div>
    </div>
</div>

<script>

    function resetClick(){
        location.reload();
    }

    $('#CustomerDefaultVal').on('paste', function (event) {
        if (event.originalEvent.clipboardData.getData('Text').match(/[^\d]/)) {
            event.preventDefault();
        }
    });

    function resetClick(){
        location.reload();
    }

    $(document).ready(function () {
        function isNumberKey(evt) {
            var charCode = (evt.which) ? evt.which : event.keyCode;
            if (charCode != 46 && charCode > 31
                && (charCode < 48 || charCode > 57))
                return false;

            return true;
        }

        //$("#alternameMobSection .deleteButton").each(function () {
        //    var row = $(this).closest("tr");
        //    var MobileNo = row.find('.mbNo').val();
        //});

     });


     var mobNoArr = [];
     var mobN;
     function OnSuccess(res){
         console.log(res);
         if (res.searchList.success == true) {

             document.getElementById("noRecord").style.display = "none";
             document.getElementById("successUpdate").style.display = "none";

             var basicCustDetails = res.searchList.data.customerDetail;
             var alternameMobDetails = res.searchList.data.customerMultipleMobileDetail;

             $("#customerName").val(basicCustDetails[0].customerName);
             $("#NameOnCard").val(basicCustDetails[0].nameOnCard);
             $("#RegisteredMobile").val(basicCustDetails[0].communicationMobileNo);

             $("#alternameMobSection td").parent().remove();

             for(var i =0; i<4;i++){
                 var appendFields = "<tbody><tr>"
                                 + "<td style='vertical-align:middle'>Mobile Number</td>"
                                 + "<td style='display:flex;' class='mbbNo'><input type='text' id='MobNoId_"+i+"' maxlength='10' onkeypress='return isNumberKey(event)' onblur='mobNoChange(this," + (i) + ")' style='width:80%;' class='form-control mbNo cgl'/><i style='display:none;margin-top:10px;margin-left:5px;' class='fa fa-exclamation-triangle errs' id='mobNoErr"+i+"' aria-hidden='true'></i></td>"
                                 + "<td style='vertical-align:middle'>Name</td>"
                                 + "<td style='display:flex;'><input type='text' maxlength='30' id='NameId_"+i+"' style='width:80%;' onblur='nameOnChange(this," + (i) + ")' class='form-control nm'/><i style='display:none;margin-top:10px;margin-left:5px;' class='fa fa-exclamation-triangle errs' id='nameErr"+i+"' aria-hidden='true'></i></td>"
                                 + "<td style='vertical-align:middle'>Designation</td>"
                                 + "<td style='display:flex;'><input type='text' maxlength='30' id='DesignationId_"+i+"' style='width:80%;' onblur='designationOnChange(this," + (i) + ")' class='form-control desgn'/><i style='display:none;margin-top:10px;margin-left:5px;' class='fa fa-exclamation-triangle errs' id='designationErr"+i+"' aria-hidden='true'></i></td>"
                                 + "<td class='deleteButton'></td>"
                                 + "</tr></tbody>";

                $("#alternameMobSection").append(appendFields);
             }

             for(var j=0;j<alternameMobDetails.length;j++){
                 $("#MobNoId_"+j).val(alternameMobDetails[j].mobileNo);
                 $("#NameId_"+j).val(alternameMobDetails[j].name);
                 $("#DesignationId_"+j).val(alternameMobDetails[j].designation);
                 mobNoArr.push({mobN:alternameMobDetails[j].mobileNo});
             }

             var cnt = 0;

             $("#alternameMobSection .deleteButton").each(function () {

                    var row = $(this).closest("tr");

                    var Mob = row.find('.mbNo').val();
                    if(Mob == ''){
                        row.find('.deleteButton').append("");
                        row.find('.mbNo').attr("readonly", false);
                        row.find('.mbNo').removeClass("rdn");
                    }else{
                        row.find('.deleteButton').append("<button class='btn btn_primary dlt' type='button'>Delete</button>");
                        row.find('.mbNo').attr("readonly", true);
                        row.find('.mbNo').addClass("rdn");
                        cnt++;
                    }
             });

             if(cnt == 4){
                 $("#submitSection").hide();
             }

             document.getElementById("updateSection").style.display = "block";
         }else{
            document.getElementById("updateSection").style.display = "none";
            $("#noRecord").html("");
            $("#noRecord").append("<span>" + res.searchList.message + "</span>");
            document.getElementById("noRecord").style.display = "block";
         }
     }

    $("#alternameMobSection").on('paste', '.cgl', function (event) {
        if (event.originalEvent.clipboardData.getData('Text').match(/[^\d]/)) {
            event.preventDefault();
        }
    });

     function updateAlertnateMob(){

         document.getElementById("successDelete").style.display = "none";

         var updateArray = new Array();
         var flag = "Y";
         var indexS=0;

         var dupl = "Y";

         var cntFlag = 0;

         $("#alternameMobSection .deleteButton").each(function () {

                var row = $(this).closest("tr");

                var selectedRow = $(this).closest("tr")[0];

                indexS = (selectedRow.rowIndex) - 1;

                var MobileNo = row.find('.mbNo').val();
                var Name = row.find('.nm').val();
                var Designation = row.find('.desgn').val();

                var CustomerID = $("#CustomerDefaultVal").val();

                if(MobileNo != ''){
                    updateArray.push({
                        CustomerID: CustomerID,
                        MobileNo: MobileNo,
                        Name: Name,
                        Designation: Designation
                    })
                }


                var rowM=$(this).closest('td').closest('tr');
                var count=rowM[0].rowIndex;

                if(MobileNo.trim() != ''){
                    if(!MobileNo.match(/^[6789]\d{9}$/)){
                        document.getElementById('mobNoErr'+count).title="Invalid Mobile Number";
                        document.getElementById('mobNoErr'+count).style.display = "block";
                        flag = "N";
                    }else{
                        $('#alternameMobSection tbody tr').each(function () {
                            var row = $(this);
                            var index=row[0].rowIndex;
                            var mobNo = row.find("td.mbbNo input[type='text']").val();
                            if(mobNo==MobileNo && index!=count){
                                    cntFlag++;
                            }
                        });
                    }
                }


                if(Name.trim() != ''){
                    if(!Name.match(atLeastOneAlphabet)){
                        document.getElementById('nameErr'+indexS).title="Invalid Name";
                        document.getElementById('nameErr'+indexS).style.display = "block";
                        flag = "N";
                    }
                }

                if(Designation.trim() != ''){
                    if(!Designation.match(atLeastOneAlphabet)){
                        document.getElementById('designationErr'+indexS).title="Invalid Designation";
                        document.getElementById('designationErr'+indexS).style.display = "block";
                        flag = "N";
                    }
                }
         });

        if(cntFlag>0){
            alert("Duplicate Mobile Number");
            flag = "N";
        }

         console.log("updateArray",updateArray);

         if (flag == "N")
            e.preventDefault();

        if (flag == "Y") {
          if (confirm('Are you sure you want to submit ?')) {
                console.log('ok');

                $.ajax({
                    url: "@Url.Action("UpdateSmsAlertForMultipleMobileDetail", "CustomerRequest")",
                    type: "POST",
                    traditional: true,
                    data: { customerDetailForSmsAlert: JSON.stringify(updateArray) },
                    success: function (res) {

                        if(res.reasonList[0].status == 1){
                             document.getElementById("updateSection").style.display = "none";
                             document.getElementById("noRecord").style.display = "none";
                             $("#CustomerDefaultVal").val('');
                             $("#successUpdate").html("");
                             $("#successUpdate").append("<span>" + res.reasonList[0].reason + "</span>");
                             document.getElementById("successUpdate").style.display = "block";
                        }else{
                            $("#noRecord").html("");
                            $("#noRecord").append("<span>" + res.reasonList[0].reason + "</span>");
                            document.getElementById("noRecord").style.display = "block";
                        }
                    },
                    error: function (ex) {
                        alert('Failed' + ex);
                    }
                });

            } else {
                console.log('cancel')
            }
         }
     }


    $("#alternameMobSection").on('click', '.deleteButton', function (e) {

        var currentRow = $(this).closest("tr");

        var selectedRow = $(this).closest("tr")[0];

        var indexS = selectedRow.rowIndex;

        console.log("indexS",indexS);

        var CustomerID = $("#CustomerDefaultVal").val();
        var MobileNo = currentRow.find('.mbNo').val();

        if(currentRow.find('.deleteButton').html() != ''){
            if (confirm('Are you sure you want to delete ?')) {
                    console.log('ok');

                $.ajax({
                    url: "@Url.Action("DeleteSmsAlertForMultipleMobileDetail", "CustomerRequest")",
                    type: "POST",
                    traditional: true,
                    data: { CustomerID:CustomerID, MobileNo:MobileNo },
                    success: function (res) {

                        console.log("res",res);

                        if(res.reasonList[0].status == 1){
                                document.getElementById("alternameMobSection").deleteRow(indexS);

                                  $.ajax({
                                    url: "@Url.Action("ConfigureSMSAlertstoMultipleMobileNumber", "CustomerRequest")",
                                    type: "POST",
                                    traditional: true,
                                    data: $('#formVal').serialize(),
                                    success: function (res) {

                                       console.log("res duplicate",res);

                                         var alternameMobDetails = res.searchList.data.customerMultipleMobileDetail;

                                         $("#alternameMobSection td").parent().remove();

                                         for(var i =0; i<4;i++){
                                             var appendFields = "<tbody><tr>"
                                                                 + "<td style='vertical-align:middle'>Mobile Number</td>"
                                                                 + "<td style='display:flex;' class='mbbNo'><input type='text' id='MobNoId_"+i+"' maxlength='10' onkeypress='return isNumberKey(event)' onblur='mobNoChange(this," + (i) + ")' style='width:50%;' class='form-control mbNo cgl'/><i style='display:none;margin-top:10px;margin-left:5px;' class='fa fa-exclamation-triangle errs' id='mobNoErr"+i+"' aria-hidden='true'></i></td>"
                                                                 + "<td style='vertical-align:middle'>Name</td>"
                                                                 + "<td style='display:flex;'><input type='text' id='NameId_"+i+"' maxlength='30' style='width:50%;' onblur='nameOnChange(this," + (i) + ")' class='form-control nm'/><i style='display:none;margin-top:10px;margin-left:5px;' class='fa fa-exclamation-triangle errs' id='nameErr"+i+"' aria-hidden='true'></i></td>"
                                                                 + "<td style='vertical-align:middle'>Designation</td>"
                                                                 + "<td style='display:flex;'><input type='text' id='DesignationId_"+i+"' maxlength='30' style='width:50%;' onblur='designationOnChange(this," + (i) + ")' class='form-control desgn'/><i style='display:none;margin-top:10px;margin-left:5px;' class='fa fa-exclamation-triangle errs' id='designationErr"+i+"' aria-hidden='true'></i></td>"
                                                                 + "<td class='deleteButton'></td>"
                                                                 + "</tr></tbody>";

                                            $("#alternameMobSection").append(appendFields);
                                         }

                                         for(var j=0;j<alternameMobDetails.length;j++){
                                             $("#MobNoId_"+j).val(alternameMobDetails[j].mobileNo);
                                             $("#NameId_"+j).val(alternameMobDetails[j].name);
                                             $("#DesignationId_"+j).val(alternameMobDetails[j].designation);
                                         }

                                         $("#alternameMobSection .deleteButton").each(function () {

                                                var row = $(this).closest("tr");

                                                var Mob = row.find('.mbNo').val();
                                                if(Mob == ''){
                                                    row.find('.deleteButton').append("");
                                                    row.find('.mbNo').attr("readonly", false);
                                                }else{
                                                    row.find('.deleteButton').append("<button class='btn btn_primary dlt' type='button'>Delete</button>");
                                                    row.find('.mbNo').attr("readonly", true);
                                                }
                                         });

                                         $("#submitSection").show();
                                    },
                                    error: function (ex) {
                                        alert('Failed' + ex);
                                    }
                                });

                            $("#successDelete").html("");
                            $("#successDelete").append("<span>" + res.reasonList[0].reason + "</span>");
                            document.getElementById("successDelete").style.display = "block";

                        }else{
                            document.getElementById("successDelete").style.display = "none";
                        }
                    },
                    error: function (ex) {
                        alert('Failed' + ex);
                    }
                });

            } else {
                console.log('cancel')
            }
        }
    });

    function mobNoChange(o, rowSelected) {
           var mobileNo = o.value;
           var row=$(this).closest('td').closest('tr');
           if(mobileNo.trim() != ''){
                if(!mobileNo.match(/^[6789]\d{9}$/)){
                    document.getElementById('mobNoErr'+rowSelected).title="Invalid Mobile Number";
                    document.getElementById('mobNoErr'+rowSelected).style.display = "block";
                    return false;
                }else{
                     document.getElementById('mobNoErr'+rowSelected).style.display = "none";
                }
           }
    }

    function nameOnChange(o, rowSelected){
        var name = o.value;
        if(name.trim() != ''){
            if(!name.match(atLeastOneAlphabet)){
                document.getElementById('nameErr'+rowSelected).title="Invalid Name";
                document.getElementById('nameErr'+rowSelected).style.display = "block";
                return false;
            }else{
                document.getElementById('nameErr'+rowSelected).style.display = "none";
            }
        }
    }

    function designationOnChange(o, rowSelected){
        var designation = o.value;
        if(designation.trim() != ''){
            if(!designation.match(atLeastOneAlphabet)){
                document.getElementById('designationErr'+rowSelected).title="Invalid Designation";
                document.getElementById('designationErr'+rowSelected).style.display = "block";
                return false;
            }else{
                document.getElementById('designationErr'+rowSelected).style.display = "none";
            }
        }
    }
</script>