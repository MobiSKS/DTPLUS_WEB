@model HPCL.Common.Models.ViewModel.TatkalCardCustomer.MapTatkalCardtoCustomerModel
@using Microsoft.AspNetCore.Http;

<div class="col-lg-12">
    <div class="bg-white p-2 p-md-4">
        <ul class="breadcrumb bread_custom bg-transparent m-0 pb-1 py-0 px-0">
            <li class="breadcrumb-item"><a href="@Url.Action("Index","TatkalCardCustomer")" class="text_primary">Tatkal Card Customer</a> </li>
            <li class="breadcrumb-item font-weight-light">Map Tatkal Cards To Tatkal Customer</li>
        </ul>

        <div id="reason" class="mb-3 text-center alert alert-success" style=""></div>
        <form class="toBeHiddenOnSuccess">
            <div class="w-100">
                <div class="col-lg-12 col-md-12 col-12 pl-0 pr-0">
                    <div class="border-1 rounded border-grey pb-3">
                        <p class="text_primary px-3 py-3 bg-grey m-0 font-weight-bold">Map Tatkal Cards To Tatkal Customer</p>
                        <button class="btn btn_primary add_update_btn" type="button">DOWNLOAD UNALLOCATED CARDS</button>
                        <div class="col-lg-12 col-md-12 col-12 py-3">
                            <div class="d-flex align-items-center flex-wrap">
                                <div class="col-lg-6 col-12">
                                    <div class="d-flex align-items-center flex-wrap mb-3">
                                        <label id="lblCustomerId" class="font-weight-normal col-md-3 col-12">Customer ID<sup class="text-danger">*</sup></label>
                                        <div class="col-md-7 col-12">
                                            <div class="custom_select">
                                                @Html.TextBoxFor(m => m.CustomerId, new { @class = "form-control", maxlength = "10", onkeypress = "return isNumberKey(event)", autocomplete = "off" })
                                                <span style="display:none" class="error" id="customerId_error"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>


                            <div class="clearfix"></div>
                            <div class="d-flex align-items-center justify-content-center mt-0">
                                <div class="px-2">
                                    <button class="btn btn_primary" type="button" id="btnSearch">GET UNALLOCATED CARD</button>
                                </div>


                            </div>

                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </div>
        </form>
        <div class="clearfix"></div>
        <div id="message" tabindex="0" class="mb-3 text-center" style="display:none">
        </div>
        <div class="clearfix"></div>
        <div id="divtable" class="toBeHiddenOnSuccess" style="display:none">
            <table id="CardDetailsTbl" class="table" style="width:100%;">
                <thead>
                    <tr>
                        <th colspan="6">Select Un-Allocated Card(s) <input type="checkbox" id="checkAll" name="checkAll" value="checkAll"> Select All</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <div class="clearfix"></div>

            <div class="d-flex align-items-center justify-content-center mt-0">
                <div class="px-2">
                    <button class="btn btn_primary" type="button" id="btnMap">MAP</button>
                </div>

                <div class="px-2">
                    <button class="btn btn_primary" type="button" id="btnReset">RESET</button>
                </div>

            </div>
        </div>
        <div class="clearfix"></div>
        <div class="border-1 rounded border-grey pb-3 toBeHiddenOnSuccess">
            <p class="text_primary px-3 py-2 m-0 font-weight-bold">Upload Card details File</p>
            <div class="d-flex align-items-center flex-wrap">
                <div class="col-lg-6 col-12">
                    <div class="d-flex align-items-center flex-wrap mb-2">
                        <label id="lblCustomerId" class="font-weight-normal col-md-3 col-12">Select File<sup class="text-danger">*</sup></label>
                        <div class="col-md-6 col-12">
                            <div class="custom_select">
                                @Html.TextBoxFor(m => m.FileId, new { @class = "form-control form-control-file", Type = "file" })
                            </div>
                        </div>
                        <div class="clearfix"></div>
                        <div class="col-md-3 col-12">
                            <div class="px-2">
                                <button  class="btn btn_primary" type="button" id="btnUpload">Upload</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>
</div>
<script type="text/javascript">

    $("#btnSearch").click(function () {

        var customerId = $("#CustomerId").val();
         var flag="Y";
           if(customerId=="")
           {
               $("#customerId_error").attr("style", "display:block");
               $("#customerId_error").html("Enter Customer ID");
               $("#CustomerId").focus();
               flag="N";
           }
           else
           {
                $("#customerId_error").attr("style", "display:none");
                flag="Y";
                if (!customerId.match(mappedCustomerId))
                {
                    $("#customerId_error").attr("style", "display:block");
                    $("#customerId_error").html("Invalid Customer ID");
                    $("#CustomerId").focus();
                     flag="N";
                }
                else
                {
                    $("#customerId_error").attr("style", "display:none");
                     flag="Y";
                }
           }
           if(flag=="Y"){
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("GetMapTatkalCardtoCustomer", "TatkalCardCustomer")',
                    data: { CustomerID: customerId},
                    dataType: "json",
                    success: function (data, status, xhr) {
                        console.log(data);
                        if (status == 'success') {
                            if(data.objGetStatusTatkalCardsToTatkalCustomer.length > 0) {
                                if(data.objGetStatusTatkalCardsToTatkalCustomer[0].status=="0")
                                {
                                    $("#customerId_error").attr("style", "display:block");
                                    $("#customerId_error").html(data.objGetStatusTatkalCardsToTatkalCustomer[0].reason);
                                    $("#CustomerId").focus();
                                }
                                else
                                {
                             
                                 $("#message").attr("style", "display:none");
                                 $("#CardDetailsTbl td").parent().remove();
                                 if (data.objGetCardDetailsTatkalCardsToTatkalCustomer.length > 0) {
                                       var count = data.objGetCardDetailsTatkalCardsToTatkalCustomer.length;
                                        var rowcount = Math.ceil((count) / 6);
                                          var cnt = 0;
                                       var rows = "<tbody>";
                                       for (var i = 0; i <= rowcount; i++){
                                       rows += "<tr>";
                                           for (var j = 0; j < 6; j++){
                                               if (cnt < data.objGetCardDetailsTatkalCardsToTatkalCustomer.length){
                                                   rows += "<td><label><input type='checkbox' name='' value='" + data.objGetCardDetailsTatkalCardsToTatkalCustomer[cnt].cardNo + "'/>"+ data.objGetCardDetailsTatkalCardsToTatkalCustomer[cnt].cardNo +"</label></td>";
                                                   cnt = cnt + 1;
                                               }
                                           }
                                           rows += "</tr>";
                                           }
                                           rows += "</tbody>";
                                           $('#CardDetailsTbl').append(rows);
                                           $("#message").attr("style", "display:none");
                                           $("#divtable").attr("style", "display:block");

                                 }
                                 
                                  else {
                                     $("#message").html("");
                                     $("#message").append(data.message);

                                     $("#message").attr("style", "display:block;background-color:#f9c9c9; color:#8d0d0d; border-color: #f3abab;");
                                     $("#divtable").attr("style", "display:none");

                                 }
                             }
                           }
                        }
                    },
                    error: function (jqXhr, textStatus, errorMessage) {
                        alert("Error " + textStatus +errorMessage);
                    }
                });
            }

    });

      $("#checkAll").click(function () {
        $('input:checkbox').not(this).prop('checked', this.checked);
    });
      $("#btnReset").click(function () {
        window.location.reload(true);

    });
      $("#btnMap").click(function () {

        CardDetails = [];
         $("#CardDetailsTbl tbody tr").each(function () {

             var row = $(this);
             $(this).find('td').each(function(){
             if ($(this).find('input[type="checkbox"]').is(":checked")) {

                 var cardNo = $(this).find(':checkbox:checked').val();
                 CardDetails.push({ CardNo: cardNo });

            }
            });
         });
         var customerId = $("#CustomerId").val();
           if(CardDetails.length<2 ||CardDetails.length>100){
                $("#message").html("");
                $("#message").append("Min 2 and Max 100 Cards will be allowed");
                $("#message").attr("style", "display:block;background-color:#f9c9c9; color:#8d0d0d; border-color: #f3abab;");

                  $("#message").focus();
           }
           else{

                $("#message").attr("style", "display:none");
           }
           var flag="Y";
           if(customerId=="")
           {
               $("#customerId_error").attr("style", "display:block");
               $("#customerId_error").html("Enter Customer ID");
               $("#CustomerId").focus();
               flag="N";
           }
           else
           {
                $("#customerId_error").attr("style", "display:none");
                flag="Y";
                if (!customerId.match(mappedCustomerId))
                {
                    $("#customerId_error").attr("style", "display:block");
                    $("#customerId_error").html("Invalid Customer ID");
                    $("#CustomerId").focus();
                     flag="N";
                }
                else
                {
                    $("#customerId_error").attr("style", "display:none");
                     flag="Y";
                }
           }

        if (CardDetails.length >= 2 && CardDetails.length<=100  && flag=="Y") {
            //if (confirm("Are you sure ?")) {

                var model = { Customerid: customerId,  ObjCardMap: CardDetails };
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("UpdateTatkalCardtoCustomer", "TatkalCardCustomer")',
                    contentType: "application/json; charset=utf-8",
                    dataType: 'json',
                    data: JSON.stringify(model),
                    success: function (data) {
                        $("#reason").html(data);
                        $(".toBeHiddenOnSuccess").hide();

                    },
                  error: function (jqXhr, textStatus, errorMessage) {
                    alert("Error " + textStatus +errorMessage);
                }
                });
            }
            //}
         });

</script>