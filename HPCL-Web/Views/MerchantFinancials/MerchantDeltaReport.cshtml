@model HPCL.Common.Models.ResponseModel.MerchantFinancial.MerchantDeltaReportModel
@using Microsoft.AspNetCore.Http;

<div class="col-lg-12 p-4 p-md-4">
    <div class="bg-white p-2 p-md-4">
        <ul class="breadcrumb bread_custom bg-transparent m-0 pb-1 py-0 px-0">
            <li class="breadcrumb-item"><a href="@Url.Action("Index","MerchantFinancials")" class="text_primary">Financial</a> </li>
            <li class="breadcrumb-item font-weight-light">Merchant Sale/Reload Delta Details</li>
        </ul>
        <form>
            <div class="w-100">
                <div class="col-lg-12 col-md-12 col-12 pl-0 pr-0">
                    <div class="border-1 rounded border-grey pb-3">
                        <p class="text_primary px-3 py-2 bg-grey m-0 font-weight-bold">Merchant Sale/Reload Delta Details</p>
                        <div class="col-lg-12 col-md-12 col-12 py-3">
                            <div class="d-flex align-items-center flex-wrap">
                                <div class="col-lg-6 col-12">
                                    <div class="d-flex align-items-center flex-wrap mb-3">
                                        <label class="col-md-3 col-12">&nbsp;</label>
                                        <div class="col-md-7 col-12">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input rbOption" type="radio" name="reportOption" id="rbCustomerId" value="merchant" checked>
                                                <label class="form-check-label" for="rbCustomerId">Merchant</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input rbOption" type="radio" name="reportOption" id="rbTerminalId" value="terminal">
                                                <label class="form-check-label" for="rbTerminalId">Terminal</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center flex-wrap">
                                <div class="col-lg-6 col-12">
                                    <div class="d-flex align-items-center flex-wrap mb-3">
                                        <label id="lblMerchantId" class="font-weight-normal col-md-3 col-12">Merchant Id<sup class="text-danger">*</sup></label>
                                        <label id="lblTerminalId" class="font-weight-normal col-md-3 col-12" style="display:none">Terminal Id<sup class="text-danger">*</sup></label>

                                        <div class="col-md-7 col-12">
                                            <div class="custom_select" id="merchantIdDiv">
                                                @Html.TextBoxFor(m => m.MerchantId, new { @class = "form-control", maxlength = "10", onkeypress = "return isNumberKey(event)", autocomplete = "off" })
                                            </div>
                                            <div class="custom_select" id="terminalIdDiv" style="display:none">
                                                @Html.TextBoxFor(m => m.TerminalId, new { @class = "form-control", maxlength = "10", onkeypress = "return isNumberKey(event)", autocomplete = "off" })
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-12 offset-3 offset-md-3">
                                            <span style="display:none" class="error" id="merchantId_error"></span>
                                        </div>

                                    </div>
                                </div>

                            </div>
                            <div class="d-flex align-items-center flex-wrap">
                                <div class="col-lg-6 col-12">
                                    <div class="d-flex align-items-center flex-wrap mb-3">
                                        <label class="font-weight-normal col-md-3 col-12">From Date <sup class="text-danger">*</sup></label>
                                        <div class="col-md-7 col-12">
                                            <div class="custom_select">
                                                @Html.TextBoxFor(m => m.FromDate, new { @class = "form-control date", @type = "date" })
                                            </div>

                                        </div>
                                        <div class="col-12 col-md-12 offset-3 offset-md-3">
                                            <span style="display:none" class="error" id="fromDate_error"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center flex-wrap">
                                <div class="col-lg-6 col-12">
                                    <div class="d-flex align-items-center flex-wrap mb-3">
                                        <label class="font-weight-normal col-md-3 col-12">To Date <sup class="text-danger">*</sup></label>
                                        <div class="col-md-7 col-12">
                                            <div class="custom_select">
                                                @Html.TextBoxFor(m => m.ToDate, new { @class = "form-control date", @type = "date" })
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-12 offset-3 offset-md-3">
                                            <span style="display:none" class="error" id="toDate_error"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="clearfix"></div>
                            <div class="d-flex align-items-center justify-content-center mt-0">
                                <div class="px-2">
                                    <button class="btn btn_primary" type="button" id="btnSearch">SEARCH</button>
                                </div>
                                <div class="px-2">
                                    <button class="btn btn_primary" type="button" id="btnReset">RESET</button>
                                </div>
                                @*<div class="px-2">
                                        <button class="btn btn_primary" type="button">Export To Excel</button>
                                    </div>*@
                            </div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </div>
        </form>
        <div class="clearfix"></div>
        <div id="MerchantDeltaReport" class="table-responsive" style="display:none;">
            <table class="table table-striped table-bordered d-md-table d-block text-nowrap display table-responsive mt-3" style="width:100%;">
                <thead>
                    <tr>
                        <th>Terminal</th>
                        <th>Batch ID</th>
                        <th>Settlement Date</th>
                        <th class="text-md-right text-right">Sale Delta(Rs.)</th>
                        <th class="text-md-right text-right">Reload Delta(Rs.)</th>
                    </tr>
                </thead>
            </table>

        </div>

        <div class="clearfix"></div>
        <div>
            <div id="message" class="mb-3 text-center" style="display:none">
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    var today = new Date();
    var dd = String(today.getDate()).padStart(2, '0');
    var mm = String(today.getMonth() + 1).padStart(2, '0');
    var yyyy = today.getFullYear();
    today = yyyy + '-' + mm + '-' + dd;
    $(document).ready(function () {
        setDates();
        if ($("#rbTerminalId").is(":checked")) {
            $("#lblMerchantId").attr("style", "display:none");
            $("#lblTerminalId").attr("style", "display:block");
        }
        else {
            $("#lblMerchantId").attr("style", "display:block");
            $("#lblTerminalId").attr("style", "display:none");
        }

    });
    function setDates() {
        var setDate = new Date();
        setDate.setMonth(setDate.getMonth());
        setDate.setDate(setDate.getDate() - 1);
        var dd = String(setDate.getDate()).padStart(2, '0');
        var mm = String(setDate.getMonth() + 1).padStart(2, '0');
        var yyyy = setDate.getFullYear();

        setDate = yyyy + '-' + mm + '-' + dd;
        $("#FromDate").val(setDate);
        $("#ToDate").val(setDate);

    };
    $(".rbOption").change(function () {

        if ($("#rbTerminalId").is(":checked")) {
            $("#merchantIdDiv").attr("style", "display:none");
            $("#terminalIdDiv").attr("style", "display:block");

            $("#lblMerchantId").attr("style", "display:none");
            $("#lblTerminalId").attr("style", "display:block");

        }
        else {
            $("#merchantIdDiv").attr("style", "display:block");
            $("#terminalIdDiv").attr("style", "display:none");

            $("#lblMerchantId").attr("style", "display:block");
            $("#lblTerminalId").attr("style", "display:none");
        }

    });
    function isNumberKey(evt) {
        var charCode = (evt.which) ? evt.which : event.keyCode;
        if (charCode != 46 && charCode > 31
            && (charCode < 48 || charCode > 57))
            return false;

        return true;
    }
    $(".date").on('change', function (e) {
        var fromD = "";
        var toD = "";
        fromD = $("#FromDate").val();
        toD = $("#ToDate").val();
        checkDates(fromD, toD);
    });

    function checkDates(fromD, toD) {
        var dateflag = "Y";
        var d1 = new Date(fromD);
        var d2 = new Date(toD);
        if (fromD != "" && toD != "") {
            var aday = 24 * 60 * 60 * 1000;
            if (fromD > toD) {

                $("#fromDate_error").attr("style", "display:block");
                $("#fromDate_error").html("'From Date' should be less or equal to 'To date'");
                dateflag = "N";
            }
            else if ((Math.abs(d2 - d1) / aday) > 1) {
                $("#fromDate_error").attr("style", "display:block");
                $("#fromDate_error").html("Difference between From Date and To Date should not be more than 1 days");
                dateflag = "N";
            }
            else {
                $("#fromDate_error").html("");
                $("#fromDate_error").attr("style", "display:none");
            }
            if (toD >= today) {
                $("#toDate_error").attr("style", "display:block");
                $("#toDate_error").html("To Date should be less to Today's date");
                dateflag = "N";
            }
            else {
                $("#toDate_error").html("");
                $("#toDate_error").attr("style", "display:none");
            }

        }
        return dateflag;
    }

    $("#btnSearch").on("click", (function (e) {
         var fromdate = $("#FromDate").val();
         var todate = $("#ToDate").val();
        var merchantId = "", terminalId = "";
        if ($("#rbTerminalId").is(":checked")) {
            terminalId = $("#TerminalId").val();
         }

         else {
            merchantId = $("#MerchantId").val();
         }
         var flag = "Y";
         if (fromdate == "") {
             $("#fromDate_error").attr("style", "display:block");
             $("#fromDate_error").html("From Date is required");
             flag = "N";
         }
         if (todate == "") {
             $("#toDate_error").attr("style", "display:block");
             $("#toDate_error").html("To Date is required");
             flag = "N";
        }
         if (fromdate != "" && todate != "") {
             flag = checkDates(fromdate, todate);
        }
        if (merchantId == "" && terminalId == "" ) {
            $("#merchantId_error").attr("style", "display:block");
            $("#merchantId_error").html("ID is required");
            flag = "N";
        }
        else {
            if (merchantId != "") {
                if (!merchantId.match(mappedMerchantID)) {
                    $("#merchantId_error").attr("style", "display:block");
                    $("#merchantId_error").html("Please enter valid ID");
                    flag = "N";
                }
                else {
                    $("#merchantId_error").attr("style", "display:none");
                    $("#merchantId_error").html("");
                }

            }
            if (terminalId != "") {
                if (!terminalId.match(mappedterminalID)) {
                    $("#merchantId_error").attr("style", "display:block");
                    $("#merchantId_error").html("Please enter valid ID");
                    flag = "N";
                }
                else {
                    $("#merchantId_error").attr("style", "display:none");
                    $("#merchantId_error").html("");
                }
            }
        }


         if (flag == "N")
             e.preventDefault();

        else {
             $("#merchantId_error").attr("style", "display:none");
             $("#merchantId_error").html("");
             $("#fromDate_error").attr("style", "display:none");
             $("#fromDate_error").html("");
             $("#toDate_error").attr("style", "display:none");
             $("#toDate_error").html("");
            $.ajax({
                type: 'POST',
                url: '@Url.Action("GetMerchantDeltaReport", "MerchantFinancials")',
                data: { MerchantId: merchantId, TerminalId: terminalId, FromDate: fromdate, ToDate: todate },
                dataType: "json",
                success: function (data, status, xhr) {
                    console.log(data);
                    if (status == 'success') {
                        $("#message").attr("style", "display:none");
                        $("#MerchantDeltaReport td").parent().remove();
                        if (data.merchantDeltaReportDetails.length > 0) {
                            for (var i = 0; i < data.merchantDeltaReportDetails.length; i++) {
                                var rows = "<tbody><tr>"

                                    + "<td><span class='rowData'>" + (data.merchantDeltaReportDetails[i].terminalId || '') + "</span></td>"
                                    + "<td><span class='rowData'>" + (data.merchantDeltaReportDetails[i].batchId || '') + "</span></td>"
                                    + "<td><span class='rowData'>" + (data.merchantDeltaReportDetails[i].settlementDate || '') + "</span></td>"
                                    + "<td class='text-md-right text-right'><span class='rowData'>" + (data.merchantDeltaReportDetails[i].saleDelta || '') + "</span></td>"
                                    + "<td class='text-md-right text-right'><span class='rowData'>" + (data.merchantDeltaReportDetails[i].reloadDelta || '') + "</span></td></tr></tbody>"
                                $('#MerchantDeltaReport table').append(rows);
                            }
                        }
                        if (data.merchantDeltaReportDetails.length == 0) {
                            $("#message").html("");
                            $("#message").append("<span>" + data.message + "</span>");

                            $("#message").attr("style", "display:block;background-color:#f9c9c9; color:#8d0d0d; border-color: #f3abab;");
                            $("#MerchantDeltaReport").attr("style", "display:none");

                        }
                        else {
                            $("#message").attr("style", "display:none");
                            $("#MerchantDeltaReport").attr("style", "display:block");
                        }
                    }
                },
            });
        }
    })
    );
    $("#btnReset").click(function () {
        location.reload();

    });
</script>