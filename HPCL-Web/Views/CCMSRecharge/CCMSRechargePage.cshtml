<div class="bg-white p-md-4 p-4 w-50">
    <div class="CCMSRechargePaygateway">
        <h3 class="">CCMS Recharge through Payment gateway</h3>
        <div class="payment_gateway_form">
            <form id="submitForm">
                <div class="py-4 pr-4 pl-0 pr-md-4">
                    <div class="form-group d-flex align-items-center flex-wrap">
                        <label class="font-weight-normal col-md-4 col-12">Mobile Number </label>
                        <div class="col-md-8 col-12">
                            <div class="custom_select">
                                <input type="text" maxlength="10" id="mobNoVal" class="form-control" onkeypress = "return isNumberKey(event)">
                                @Html.ValidationMessage("mobNoVal", "", new { @id = "mobNoError", @class = "text-danger" })
                            </div>
                        </div>
                    </div>
                    <div class="form-group d-flex align-items-center flex-wrap">
                        <label class="font-weight-normal col-md-4 col-12">Customer ID <sup class="text-danger">*</sup></label>
                        <div class="col-md-8 col-12">
                            <div class="custom_select">
                                <input type="text" maxlength="10" id="customerIdVal" class="form-control" onkeypress = "return isNumberKey(event)">
                                @Html.ValidationMessage("customerIdVal", "", new { @id = "customerIdValErr", @class = "text-danger" })
                            </div>
                        </div>
                    </div>
                    <div class="form-group d-flex align-items-center flex-wrap">
                        <label class="font-weight-normal col-md-4 col-12">Control Card Number <sup class="text-danger">*</sup></label>
                        <div class="col-md-8 col-12">
                            <input type="text" id="controlCardNoVal" class="form-control" onkeypress = "return isNumberKey(event)">
                            @Html.ValidationMessage("controlCardNoVal", "", new { @id = "controlCardNoValErr", @class = "text-danger" })
                        </div>
                    </div>

                    <div class="form-group align-items-center flex-wrap" style="display:none;" id="cutomerName">
                        <label class="font-weight-normal col-md-4 col-12">Customer Name <sup class="text-danger">*</sup></label>
                        <div class="col-md-8 col-12">
                            <input type="text" id="customerNameVal" class="form-control">
                        </div>
                    </div>

                    <div class="form-group d-flex align-items-center flex-wrap">
                        <label class="font-weight-normal col-md-4 col-12">Amount <sup class="text-danger">*</sup></label>
                        <div class="col-md-8 col-12">
                            <input type="text" id="amountVal" class="form-control">
                            @Html.ValidationMessage("amountVal", "", new { @id = "amountValErr", @class = "text-danger" })
                        </div>
                    </div>

                    <table id="mobNoSearchRes" class="table table-bordered" style="display:none;">
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>Customer ID</th>
                                <th>Customer Name</th>
                                <th>Customer Type</th>
                            </tr>
                        </thead>
                    </table>


                    <div class="form-group d-flex align-items-center flex-wrap">
                        <label class="font-weight-normal col-md-4 col-12">Payment Gateway </label>
                        <div class="col-md-8 col-12">
                            <div class="custom_select">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios1" value="option1" checked>
                                    <label class="form-check-label" for="exampleRadios1">
                                        <strong>HDFC PG </strong>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group d-flex align-items-center flex-wrap">
                        <label class="font-weight-normal col-md-4 col-12"></label>
                        <div class="col-md-8 col-12">
                            <div class="custom_select">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="inlineCheckboxTC" value="option1">
                                    <label class="form-check-label" for="inlineCheckboxTC">I Agree to <a data-toggle="modal" data-target="#termsConditions">Terms &amp; Conditions</a> and <a data-toggle="modal" data-target="#App_charges">Applicable Charges</a></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-center flex-wrap mb-3">
                        <div class="offset-md-4 col-md-8 col-12">
                            <div class="px-0 float-left mr-3">
                                <button class="btn btn_primary" type="button" onclick="submitRec()">SUBMIT</button>
                            </div>
                            <div class="px-0 float-left">
                                <button class="btn btn_primary" onclick="resetClick()">RESET</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <div id="customerDetailsSection" style="display:none;">
                <div class="d-flex align-items-center flex-wrap">
                    <div class="col-lg-12 col-12">
                        <div class="d-flex align-items-center flex-wrap mb-2">
                            <label class="font-weight-normal col-md-4 col-12 mb-0">Customer ID: </label>
                            <div class="col-md-7 col-12">
                                <div class="custom_select" id="customerIdFinal">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12 col-12">
                        <div class="d-flex align-items-center flex-wrap mb-2">
                            <label class="font-weight-normal col-md-4 col-12 mb-0">Control Card Number: </label>
                            <div class="col-md-6 col-12">
                                <div class="custom_select" id="controlCardNoFinal">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12 col-12">
                        <div class="d-flex align-items-center flex-wrap mb-2">
                            <label class="font-weight-normal col-md-4 col-12 mb-0">Customer Name: </label>
                            <div class="col-md-7 col-12">
                                <div class="custom_select" id="customerNameFinal">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12 col-12">
                        <div class="d-flex align-items-center flex-wrap mb-2">
                            <label class="font-weight-normal col-md-4 col-12 mb-0">Amount: </label>
                            <div class="col-md-7 col-12">
                                <div class="custom_select" id="amountValFinal">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12 col-12">
                        <div class="d-flex align-items-center flex-wrap mb-2">
                            <label class="font-weight-normal col-md-4 col-12 mb-0">Payment throught: </label>
                            <div class="col-md-6 col-12">
                                <div class="custom_select">
                                    HDFCPG
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12 col-12">
                        <div class="d-flex align-items-center justify-content-center flex-wrap mb-2">
                            <div class="offset-md-4 col-md-8 col-12">
                                <div class="px-0 float-left mr-3">
                                    <button class="btn btn_primary" type="button" onclick="redirectToOTP()">CONFIRM</button>
                                </div>
                                <div class="px-0 float-left">
                                    <button class="btn btn_primary" onclick="cancelClick()">CANCEL</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="otpSection" style="display:none;">
                <div class="py-4 pr-4 pl-0 pr-md-4">
                    <p style="color:green;" id="otpMsg"></p>
                    <div class="form-group d-flex align-items-center flex-wrap">

                        <label class="font-weight-normal col-md-4 col-12">Enter OTP </label>
                        <div class="col-md-8 col-12">
                            <div class="custom_select">

                               @* <input type="hidden" id="storeOtp">
*@
                                <input type="text" maxlength="6" id="otpVal" class="form-control" onblur="otpValidate(this)" onkeypress = "return isNumberKey(event)">
                                <span><a style="color:#0012ff;outline:none;" onclick="resendOtp()">Resend OTP</a> Maximum three attempt</span>
                                @Html.ValidationMessage("otpVal", "", new { @id = "otpValErr", @class = "text-danger" })
                            </div>
                        </div>
                    </div>

                    <div class="d-flex align-items-center justify-content-center flex-wrap mb-3">
                        <div class="offset-md-4 col-md-8 col-12">
                            <div class="px-0 float-left mr-3">
                                <button class="btn btn_primary" type="button" onclick="confirmOTP()">CONTINUE</button>
                            </div>
                            <div class="px-0 float-left">
                                <button class="btn btn_primary" onclick="cancelOtpClick()">CANCEL</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>



<script>

    $(document).ready(function () {

        function isNumberKey(evt) {
            var charCode = (evt.which) ? evt.which : event.keyCode;
            if (charCode != 46 && charCode > 31
                && (charCode < 48 || charCode > 57))
                return false;

            return true;
        }

    });


    $("#amountVal").on('keydown', function (event) {
        if (event.shiftKey == true) {
            event.preventDefault();
        }
        debugger;
        if ((event.keyCode >= 48 && event.keyCode <= 57) || (event.keyCode >= 96 && event.keyCode <= 105) || event.keyCode == 8 || event.keyCode == 9 || event.keyCode == 37 || event.keyCode == 39 || event.keyCode == 46 || event.keyCode == 190 || event.keyCode==110) {

        } else {
            event.preventDefault();
        }
        if($(this).val().indexOf('.') !== -1 && (event.keyCode == 190|| event.keyCode == 110))
            event.preventDefault();
     });

    function cancelOtpClick(){
        locaion.reload();
    }

    function cancelClick(){
        locaion.reload();
    }

    function resetClick(){
        location.reload();
        $("#mobNoVal").attr("readonly", false);
        $("#customerIdVal").attr("readonly", false);
        $("#controlCardNoVal").attr("readonly", false);
    }

    $("#mobNoVal").on("blur", function (){

        var mobNo = $("#mobNoVal").val();

        var flag = "Y";

        if(mobNo.trim() == ''){
            flag = "N";
        }

        if(mobNo.trim() != ''){
            if(!mobNo.trim().match(/^[6789]\d{9}$/)){
                $('#mobNoError').text("Invalid Mobile Number");
                flag = "N";
            }else{
                $('#mobNoError').text("");
            }
        }


        if (flag == "N")
            e.preventDefault();


        if(flag == "Y"){

            $('#mobNoError').text("");

            document.getElementById("mobNoSearchRes").style.display = "none";
            $("#cutomerName").removeClass("d-flex");
            document.getElementById("cutomerName").style.display = "none";

            $.ajax({
                url: "@Url.Action("CCMSRechargePage","CCMSRecharge")",
                type: "POST",
                dataType: "JSON",
                data: { mobNo: mobNo, customerId: null },
                success: function (res) {

                    console.log(res,"res");

                    if(res.searchList.success == true){

                        $("#mobNoSearchRes td").parent().remove();

                        for (var i = 0; i < res.searchList.data.length; i++) {

                            var rows = "<tbody><tr>"
                                + "<td><input type='radio' class='merchantRow' name='merchantCheck'></td>"
                                + "<td><span class='customerIdVal'>" + (res.searchList.data[i].customerID || '') + "</span></td>"
                                + "<td><span class='customerNameVal'>" + (res.searchList.data[i].customerName || '') + "</span></td>"
                                + "<td><span class='customerTypeVal'>" + (res.searchList.data[i].customerType || '') + "</span><span style='display:none;' class='conCardNoVal'>"+(res.searchList.data[i].controlCardNo || '')+"</span></td>"
                                + "</tr ></tbody>";

                            $('#mobNoSearchRes').append(rows);
                        }

                        document.getElementById("mobNoSearchRes").style.display = "block";

                        $("#mobNoVal").attr("readonly", true);
                        $("#customerIdVal").attr("readonly", true);
                        $("#controlCardNoVal").attr("readonly", true);

                    }else{
                        document.getElementById("mobNoSearchRes").style.display = "none";
                        $("#cutomerName").removeClass("d-flex");
                        document.getElementById("cutomerName").style.display = "none";
                        alert(res.searchList.message);
                    }
                },
                error: function (ex) {
                    alert('Failed' + ex);
                }
            });
        }
    });

    $("#customerIdVal").on("blur", function (){

        var customerId = $("#customerIdVal").val();

        var flag = "Y";

        if(customerId == ""){
            $('#customerIdValErr').text("Please enter Customer ID");
            flag = "N";
        }
        if(customerId.trim() != ''){
            if(!customerId.trim().match(mappedCustomerId)){
                $('#customerIdValErr').text("Invalid Customer ID");
                flag = "N";
            }else{
                $('#customerIdValErr').text("");
            }
        }

        if (flag == "N")
            e.preventDefault();


        if(flag == "Y"){

            $('#mobNoError').text("");

            document.getElementById("mobNoSearchRes").style.display = "none";
            $("#cutomerName").removeClass("d-flex");
            document.getElementById("cutomerName").style.display = "none";

            $.ajax({
                url: "@Url.Action("CCMSRechargePage","CCMSRecharge")",
                type: "POST",
                dataType: "JSON",
                data: { mobNo: null, customerId: customerId },
                success: function (res) {

                    console.log(res,"res");

                    if(res.searchList.success == true){

                        $("#customerIdVal").val(res.searchList.data[0].customerID);
                        $("#customerNameVal").val(res.searchList.data[0].customerName);
                        $("#controlCardNoVal").val(res.searchList.data[0].controlCardNo);
                        
                        $("#mobNoVal").attr("readonly", true);
                        $("#customerIdVal").attr("readonly", true);
                        $("#controlCardNoVal").attr("readonly", true);

                    }else{
                        $("#cutomerName").removeClass("d-flex");
                        document.getElementById("cutomerName").style.display = "none";
                        alert(res.searchList.message);
                    }
                },
                error: function (ex) {
                    alert('Failed' + ex);
                }
            });
        }
    });

    $("#mobNoSearchRes").on('click', '.merchantRow', function (e) {

        var currentRow = $(this).closest("tr");

        if ($(this).is(':checked')) {

            $("#cutomerName").addClass("d-flex");
            document.getElementById("cutomerName").style.display = "block";
            document.getElementById("mobNoSearchRes").style.display = "none";
            $("#customerIdVal").val(currentRow.find('.customerIdVal').text());
            $("#customerNameVal").val(currentRow.find('.customerNameVal').text());
            $("#controlCardNoVal").val(currentRow.find('.conCardNoVal').text());

        }
    });

    function submitRec(){

       var flag = "Y";

       var mobNo = $("#mobNoVal").val();
       var customerId = $("#customerIdVal").val();
       var controlCardNo = $("#controlCardNoVal").val();
       var amount = $("#amountVal").val();

        if(mobNo.trim() != ''){
            if(!mobNo.trim().match(/^[6789]\d{9}$/)){
                $('#mobNoError').text("Invalid Mobile Number");
                flag = "N";
            }
        }

        if(customerId == ""){
            $('#customerIdValErr').text("Please enter Customer ID");
            flag = "N";
        }
        if(customerId.trim() != ''){
            if(!customerId.trim().match(mappedCustomerId)){
                $('#customerIdValErr').text("Invalid Customer ID");
                flag = "N";
            }
        }

        if(controlCardNo == ""){
            $('#controlCardNoValErr').text("Please enter ControlCard Number");
            flag = "N";
        }

        if(amount == ""){
            $('#amountValErr').text("Please enter Amount");
            flag = "N";
        }

        if($("#inlineCheckboxTC").prop('checked') == false){
            alert("Please accept the terms and conditions.");
            flag = "N";
        }

        if (flag == "N")
            e.preventDefault();


        if(flag == "Y"){
            if (confirm('Are you sure you want to initiate for CCMS Recharge by Payment Gateway.?')) {
                console.log('ok');

                $("#submitForm").hide();

                $("#customerIdFinal").append("<span style='font-weight:bold'>"+$("#customerIdVal").val()+"</span>");
                $("#controlCardNoFinal").append("<span>"+$("#controlCardNoVal").val()+"</span>");
                $("#customerNameFinal").append("<span>"+$("#customerNameVal").val()+"</span>");
                $("#amountValFinal").append("<span>"+$("#amountVal").val()+"</span>");

                document.getElementById("customerDetailsSection").style.display = "block";

            } else {
                console.log('cancel')
            }
        }
    }

    function redirectToOTP(){

          var mobNo = $("#mobNoVal").val();
          var customerId = $("#customerIdVal").val();

          $.ajax({
                url: "@Url.Action("CCCMSRecGenerateOtp","CCMSRecharge")",
                type: "POST",
                dataType: "JSON",
                data: { mobNo: mobNo, customerId: customerId },
                success: function (res) {

                    console.log(res,"res");

                    if(res.getOtp.success == true){

                        //$("#storeOtp").val('');

                        //$("#storeOtp").val(res.getOtp.data[0].otp);

                        $("#otpMsg").html('');
                        $("#otpMsg").append("<span>OTP has been sent to customer registered Mobile No.</span>");
                        document.getElementById("customerDetailsSection").style.display = "none";
                        document.getElementById("otpSection").style.display = "block";

                    }else{
                        alert(res.getOtp.message);
                    }
                },
                error: function (ex) {
                    alert('Failed' + ex);
                }
            });
    }

    function confirmOTP(){

        var otpVal = $("#otpVal").val();

        var flag = "Y";

        if(otpVal == ""){
            $("#otpValErr").text("Please enter Valid OTP");
            flag = "N";
        }

        if (flag == "N")
            e.preventDefault();


        if(flag == "Y"){

           var mobNo = $("#mobNoVal").val();
           var customerId = $("#customerIdVal").val();


           $.ajax({
                url: "@Url.Action("CCCMSRecVerifyOtp","CCMSRecharge")",
                type: "POST",
                dataType: "JSON",
                data: { mobNo: mobNo, otp: otpVal, customerId:customerId },
                success: function (res) {

                    console.log(res,"res");

                    
                    if(res.verifyOtp[0].status == 1){

                        if (confirm('Are you sure you want to initiate For CCMS Recharge by Payment Gateway?')) {
                            console.log('ok');

                            var customerId = $("#customerIdVal").val();
                            var mobNo = $("#mobNoVal").val();
                            var controlCardNo = $("#controlCardNoVal").val();
                            var amount = $("#amountVal").val();

                            $.ajax({
                                url: "@Url.Action("RedirectToPG","CCMSRecharge")",
                                type: "POST",
                                dataType: "JSON",
                                data: { customerId: customerId, mobNo: mobNo, controlCardNo: controlCardNo, amount: amount },
                                success: function (res) {

                                    console.log(res,"res");

                                    var ress = JSON.stringify(res.redirectDetails.data);

                                    if(res.redirectDetails.success == true){
                          
                                        var url = '@Html.Raw(@Url.Action("RedirectToPaymentGateway", new { inputTxtValues = "dd" }))';

                                        url = url.replace("dd", encodeURIComponent(ress));

                                        window.location.href = url;
                                    }
                        
                                },
                                error: function (ex) {
                                    alert('Failed' + ex);
                                }
                            });

                        } else {
                            console.log('cancel')
                        }

                    }else{
                        alert(res.verifyOtp[0].reason);
                    }


                },
                error: function (ex) {
                    alert('Failed' + ex);
                }
           });
        }
    }

    function otpValidate(o){
        var otp = o.value;
        if(otpVal == ""){
            $("#otpValErr").text("Please enter Valid OTP");
            return false;
        }else{
             $("#otpValErr").text('');
        }
    }


     function resendOtp(){

         var mobNo = $("#mobNoVal").val();
         var customerId = $("#customerIdVal").val();

         $.ajax({
                url: "@Url.Action("CCCMSRecGenerateOtp","CCMSRecharge")",
                type: "POST",
                dataType: "JSON",
                data: { mobNo: mobNo, customerId: customerId },
                success: function (res) {

                    console.log(res,"res");

                    if(res.getOtp.success == true){
                        $("#otpMsg").html('');
                        $("#otpMsg").append("<span>OTP has been resent to customer registered Mobile No.</span>");
                    }
                },
                error: function (ex) {
                    alert('Failed' + ex);
                }
        });
     }
</script>